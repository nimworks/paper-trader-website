"use strict";(self.webpackChunkkaagzi=self.webpackChunkkaagzi||[]).push([[829],{5319:function(e,t,r){r.d(t,{A:function(){return se}});var n=r(6540),a=r(1298),o=r(1381),s=r(2476),c=r(7432),l=r(5832);const i=(0,n.createContext)({id:null,name:null,email:null,accessToken:null,checkIfAccessTokenIsAlive:()=>{},chkIfUpstoxUserIsLoggedIn:()=>{},logOut:()=>{}});function u(e){let{children:t}=e;const{0:r,1:u}=(0,n.useState)(!1),{0:d,1:f}=(0,n.useState)(null),{0:m,1:h}=(0,n.useState)(null),{0:p,1:b}=(0,n.useState)(null),{0:y,1:g}=(0,n.useState)(null),{notify:w}=(0,n.useContext)(a._),k=(0,n.useContext)(o.M),x=(0,n.useContext)(s.d),E=(0,n.useRef)(null),S=()=>{u(!1),f(null),h(null),b(null),g(null),E.current=null},v=async()=>{const e=localStorage.getItem("upstoxUser");if(!e)return S(),!1;const t=JSON.parse(e);return A(t.t)?(f(t.atk),h(t.id),b(t.nm),g(t.eml),t):(S(),localStorage.removeItem("upstoxUser"),!1)},A=e=>{try{if(!e){const t=localStorage.getItem("upstoxUser");if(t){const r=JSON.parse(t);Object.prototype.hasOwnProperty.call(r,"t")&&!isNaN(r.t)&&(e=r.t)}}if(!e)return!1;const t=new Date((new Date).toLocaleString("en-US",{timeZone:"Asia/Kolkata"})),r=new Date(t);r.setHours(3,30,0,0);const n=new Date(new Date(e).toLocaleString("en-US",{timeZone:"Asia/Kolkata"}));if(t>=r)return n>=r;{const e=new Date(r);return e.setDate(e.getDate()-1),n>=e}}catch(t){return!1}},D=e=>{if(e.source.location.href.startsWith("https://kaagzi.in/app/upstox/welcome")){e.source.close(),E.current=null;try{if(!Object.prototype.hasOwnProperty.call(e.data,"authCode"))throw new Error;(async()=>{try{u(!0);const t=await(async e=>{if(!e||"string"!=typeof e||""===e.toString().trim())return null;try{const t=await x("kaagzi-lambda-upstox-getAccessToken",{c:e,s:"wa"});if(!t)throw new Error;if(!Object.prototype.hasOwnProperty.call(t,"s"))throw new Error;if(0===t.s)throw new Error(t.m);if(1!==t.s)throw new Error;if(!Object.prototype.hasOwnProperty.call(t,"at"))throw new Error;return t.at}catch(t){return console.error(t.message||"Error fetching access token from Upstox"),null}})(e.data.authCode);if(!t)throw new Error("Error fetching access token from Upstox");const r=await(async e=>{try{const t=await fetch("https://api.upstox.com/v2/user/profile",{headers:{Authorization:"Bearer "+e,Accept:"application/json"}}).catch((e=>{throw new Error("Error fetching profile data")})),r=await t.json();if("success"!==r.status)throw new Error("Error fetching profile data");return localStorage.setItem("upstoxUser",JSON.stringify({atk:e,id:r.data.user_id,nm:r.data.user_name,eml:r.data.email,t:Date.now()})),f(e),h(r.data.user_id),b(r.data.user_name),g(r.data.email),!0}catch(t){return!1}})(t);if(!r)throw new Error("Error fetching user profile from Upstox");w("Successfully logged into Upstox","success")}catch(t){w(t.message||"Error while signing into Upstox","err")}finally{u(!1)}})()}catch(t){w("Error while signing into Upstox","err")}}},O=e=>{if(e.source==window&&(e.origin.startsWith("http://localhost:")||"https://kaagzi.in"===e.origin)&&Object.prototype.hasOwnProperty.call(e.data,"msgFlowDirection")&&"contentScript-to-webPage"===e.data.msgFlowDirection&&Object.prototype.hasOwnProperty.call(e.data,"action")&&"upstoxUserUpdated"===e.data.action)(async()=>{await v()})()};return(0,n.useEffect)((()=>(window.addEventListener("message",D),window.addEventListener("message",O),()=>{window.removeEventListener("message",D),window.removeEventListener("message",O)})),[]),(0,n.useEffect)((()=>{(async()=>{await v()})()}),[k]),n.createElement(n.Fragment,null,null!==m&&null!==d?n.createElement(i.Provider,{value:{id:m,name:p,email:y,accessToken:d,checkIfAccessTokenIsAlive:()=>!!A()||(S(),localStorage.removeItem("upstoxUser"),!1),chkIfUpstoxUserIsLoggedIn:v,logOut:()=>{d&&fetch("https://api.upstox.com/v2/logout",{method:"DELETE",headers:{Authorization:"Bearer "+d,Accept:"application/json"}}).then((e=>e.json())).then((e=>{let{status:t}=e;"success"===t&&w("Successfully logged out of Upstox","success")})).catch((e=>{w("Logged out of Upstox")})),S(),localStorage.removeItem("upstoxUser")}}},t):n.createElement(n.Fragment,null,n.createElement(l.A,{broker:"Upstox",doOnLoginClick:()=>{if(!k)return w("Network unavailable","err"),null;null!==E.current&&(E.current.close(),E.current=null);try{E.current=window.open(`https://api.upstox.com/v2/login/authorization/dialog?response_type=code&client_id=a2c79e3e-5700-4f8f-bfd0-dac97bfc9d18&redirect_uri=${encodeURIComponent("https://kaagzi.in/app/upstox/welcome")}`,"Upstox Login","popup=yes,resizable=no,location=no,menubar=no,scrollbars=yes,status=no,titlebar=no,toolbar=no,fullscreen=no,dependent=no,height=640,width=960")}catch(e){console.log(e)}},referralUrlForNewSignupWithBroker:"https://link.upstox.com/FxPt9MAeYxPsRSnS9"}),r&&n.createElement(c.A,{note:"Signing into Upstox"})))}var d=r(117);const f=(0,n.createContext)({isMasterDataReady:!1,masterDataEpochTimestamp:null,getInstrument:async(e,t)=>{},getInstruments:async e=>{},getTokenForInstruments:async e=>{},searchInstruments:async(e,t,r,n,a,o,s)=>{}});function m(e){let{children:t}=e;const{0:r,1:a}=(0,n.useState)(!1),{0:s,1:l}=(0,n.useState)(!1),{0:u,1:m}=(0,n.useState)(null),h=(0,n.useContext)(o.M),{id:p}=(0,n.useContext)(d.R),{id:b,accessToken:y}=(0,n.useContext)(i),g=(0,n.useRef)(null),w=["NSE","BSE","NFO","CDS","MCX"];async function k(){return new Promise(((e,t)=>{var r;if("IDBDatabase"==(null===(r=g.current)||void 0===r?void 0:r.constructor.name)){var n,a,o;if("UpstoxMasterData"===(null===(n=g.current)||void 0===n?void 0:n.name))return e(g.current);null===(a=g.current)||void 0===a||null===(o=a.close)||void 0===o||o.call(a)}const s=indexedDB.open("UpstoxMasterData",1);s.onupgradeneeded=e=>{g.current=s.result,0===e.oldVersion?[].concat(w,["metaData"]).forEach((e=>{g.current.objectStoreNames.contains(e)||g.current.createObjectStore(e)})):e.oldVersion>0&&e.oldVersion<1&&[].concat(w,["metaData"]).forEach((e=>{g.current.createObjectStore(e)}))},s.onerror=()=>{t(s.error)},s.onsuccess=t=>{g.current=s.result,g.current.onversionchange=()=>{g.current.close(),g.current=null,console.warn("Master database is outdated, please reload the page")},g.current.onclose=()=>{g.current=null},e(g.current)}}))}const x=async(e,t)=>{if(!e)return null;if("string"==typeof e&&""===e.trim())return null;if(!["readonly","readwrite","versionchange"].includes(t))return null;try{const n=await k();if(!n)return null;const a=n.objectStoreNames;if(a.length<1)return null;const o=Array.from(a);if(Array.isArray(e)){for(var r=0;r<e.length;r++)if(!o.includes(e[r]))throw new Error("The "+e[r]+" table does not exist in cache database")}else if("string"==typeof e&&!o.includes(e))throw new Error("The "+e+" table does not exist in cache database");return n.transaction(e,t)}catch(n){return console.error("MASTER-DATA: _withDbTransaction()",n.message||n||"Error initiating transaction"),null}},E=async()=>{const e=await k();return!!e&&new Promise(((t,r)=>{try{const n=e.objectStoreNames;if(n.length<1)return t(!0);const a=Array.from(n),o=e.transaction(a,"readwrite");o.onabort=()=>r(o.error),o.oncomplete=()=>t(!0),a.forEach((e=>{o.objectStore(e).clear()}))}catch(n){r()}}))},S=async()=>{try{if(await(async()=>{try{const e=await x("metaData","readonly"),t=await new Promise(((t,r)=>{const n=e.objectStore("metaData").get("masterData_dl_timestamp");n.onerror=()=>r(n.error),n.onsuccess=()=>t(void 0!==n.result?n.result:null)}));if(!t)return!1;const r=new Date,n=new Date;n.setHours(7,30,0,0);const a=new Date(n);a.setDate(a.getDate()-1);const o=new Date(t);return r>=n?o>=n?Number(t):(E(),!1):o>=a?Number(t):(E(),!1)}catch(e){return!1}})())console.log("MASTER DATA: Already loaded and valid"),l(!0);else{if(r)return!1;console.log("MASTER DATA: Fetching"),await(async()=>{if(r)return!1;try{a(!0);const e=await Promise.all(w.map((async e=>{const t=await fetch(`https://nimworks.github.io/market-data/upstox/${e}.csv.gz`,{method:"GET",headers:{"Accept-Encoding":"gzip"}});if(!t.ok)throw new Error(`Failed to fetch ${e} data (Status: ${t.status})`);const r=await t.blob(),n=new DecompressionStream("gzip"),a=r.stream().pipeThrough(n),o=(await new Response(a).text()).trim().split("\n");return o.shift(),{xch:e,rows:o}})));if(!e||e.some((e=>!e.rows)))throw new Error("Error fetching Upstox master data");return await E(),l(!1),new Promise(((t,r)=>{(async()=>{const n=await x([].concat(w,["metaData"]),"readwrite");n.onabort=()=>r(n.error);const o=n.objectStore("NSE"),s=n.objectStore("BSE"),c=n.objectStore("NFO"),i=n.objectStore("CDS"),u=n.objectStore("MCX");e.forEach((e=>{let{xch:t,rows:r}=e;"NSE"===t?r.forEach((e=>{const[t,r]=e.split("/");o.put(r,t)})):"BSE"===t?r.forEach((e=>{const[t,r]=e.split("/");s.put(r,t)})):"NFO"===t?r.forEach((e=>{const[t,r]=e.split("/");c.put(r,t)})):"CDS"===t?r.forEach((e=>{const[t,r]=e.split("/");i.put(r,t)})):"MCX"===t&&r.forEach((e=>{const[t,r]=e.split("/");u.put(r,t)}))}));const d=n.objectStore("metaData"),f=Date.now();d.put(f,"masterData_dl_timestamp"),n.commit(),l(!0),m(f),a(!1),t(new Date(f))})()}))}catch(e){return console.error(e.message),a(!1),!1}})()}return!0}catch(e){return!1}},v={CDS:"NCD_FO",MCX:"MCX_FO"},A=(e,t,r)=>{try{if("NSE"===r||"BSE"===r){const[n,a,o]=t.split(",");if(void 0===o)return null;return""===o.trim()?{token:`${r}_INDEX|${n}`,symbol:e,name:e,lotSize:0,exchange:r,isNotTradeable:!0}:{token:`${r}_EQ|${n}`,symbol:e,name:a,lotSize:Number(o),exchange:r}}if("NFO"===r){const[n,a,o]=t.split(",");if(void 0===o)return null;const[s,c,l,i]=e.split("|");return void 0===c?{token:`NSE_FO|${n}`,symbol:e,name:e,lotSize:0,exchange:r,isNotTradeable:!0}:{token:`NSE_FO|${n}`,symbol:e,name:""===a?s:a,expiry:new Date(l).getTime(),lotSize:Number(o),type:"C"===c?"CE":"P"===c?"PE":"F"===c?"FUT":void 0,strike:"F"===c?void 0:Number(i),exchange:r}}{const[n,a]=t.split(",");if(void 0===a)return null;const[o,s,c,l]=e.split("|");return void 0===s?{token:`${v[r]}|${n}`,symbol:e,name:e,lotSize:0,exchange:r,isNotTradeable:!0}:{token:`${v[r]}|${n}`,symbol:e,name:o,expiry:new Date(c).getTime(),lotSize:Number(a),type:"C"===s?"CE":"P"===s?"PE":"F"===s?"FUT":void 0,strike:"F"===s?void 0:Number(l),exchange:r}}}catch(n){return console.error("MASTER-DATA: _parse_indexedDbKeyVal_to_instrument()",n.message||n||"Error"),null}},D=async(e,t)=>{if(!t||"string"!=typeof t)return null;if(""===t.trim())return null;try{if(!await S())return null;const r=await x(e,"readonly");return r?new Promise(((n,a)=>{const o=r.objectStore(e).get(t);o.onerror=()=>a(o.error),o.onsuccess=()=>{n(void 0!==o.result?A(t,o.result,e):null)}})):null}catch(r){return null}},O=async e=>{if(!e)return null;if("object"!=typeof e)return null;const t=Object.keys(e);if(t.length<1)return null;try{return await S()?new Promise(((r,n)=>{(async()=>{const a=await x(t,"readonly");if(!a)return null;const o=[],s=[];a.onabort=()=>n(a.error),a.oncomplete=()=>r({instrumentsFound:o,instrumentsNotFound:s});await Promise.all(t.map((async t=>{if(!w.includes(t))return!1;const r=a.objectStore(t);await Promise.all(e[t].map((e=>new Promise(((n,c)=>{const l=r.get(e);l.onsuccess=()=>{if(void 0!==l.result){const r=A(e,l.result,t);r?o.push(r):console.warn("MASTER-DATA: getInstruments() Error parsing CSV for "+e)}else s.push({symbol:e,exchange:t});n(!0)},l.onerror=()=>{console.warn("MASTER-DATA: getInstruments() Error while reading data for "+e,a.error),s.push({symbol:e,exchange:t}),n(!0)}})))));return!0})));a.commit()})()})):null}catch(r){return null}};return(0,n.useEffect)((()=>{h&&(p||b)&&(async()=>{await S()})()}),[h,p,b]),n.createElement(f.Provider,{value:{isMasterDataReady:s,masterDataEpochTimestamp:u,getInstrument:D,getInstruments:O,getTokenForInstruments:async e=>{if(!e)return null;if("object"!=typeof e)return null;const t=Object.keys(e);if(t.length<1)return null;try{return await S()?new Promise(((r,n)=>{(async()=>{const a=await x(t,"readonly");if(!a)return null;const o={},s=[];a.onabort=()=>n(a.error),a.oncomplete=()=>r({instrumentsAndTheirToken:o,instrumentsNotFound:s});await Promise.all(t.map((async t=>{if(!w.includes(t))return!1;const r=a.objectStore(t);await Promise.all(e[t].map((e=>new Promise(((n,c)=>{const l=r.get(e);l.onsuccess=()=>{if(void 0!==l.result){const r=A(e,l.result,t);null!==r&&(o[`${r.symbol}:${t}`]=r.token)}else s.push({symbol:e,exchange:t});n(!0)},l.onerror=()=>{console.warn("MASTER-DATA: getTokenForInstruments() Error while reading data for "+e,a.error),s.push({symbol:e,exchange:t}),n(!0)}})))));return!0})));a.commit()})()})):null}catch(r){return null}},searchInstruments:async(e,t,r,n,a,o,s)=>{if(""===t.trim())return null;t=t.toUpperCase(),s&&void 0!==s&&Number.isInteger(Number(s))||(s=20);if(!await S())return null;const c=await x(e,"readonly");if(!c)return null;const l={CE:"C",PE:"P",FUT:"F"};return await new Promise(((i,u)=>{try{const u=c.objectStore(e).openCursor(IDBKeyRange.bound(t,t+"￿")),d=[];let f=0;u.onsuccess=c=>{const u=c.target.result;if(u&&f<s){if(u.key.startsWith(t))if("NFO"!==e&&"CDS"!==e&&"MCX"!==e||null==r&&null==n&&null==a&&null==o){const t=A(u.key,u.value,e);t&&(d.push(t),f++)}else{let t=!0;if(r&&!u.key.includes(`|${l[r]}|`)&&(t=!1),n&&!u.key.includes(`|${n.toString()}-`)&&(t=!1),a&&!u.key.includes(`-${a<10?"0":""}${a.toString()}-`)&&(t=!1),o&&"FUT"!==r&&!u.key.endsWith(`|${o.toString()}`)&&(t=!1),t){const t=A(u.key,u.value,e);t&&(d.push(t),f++)}}u.continue()}else i(d)},u.onerror=e=>{console.warn("MASTER-DATA: searchInstruments() Cursor Error",c.error),i(null)}}catch(d){console.warn("MASTER-DATA: searchInstruments()",d.message||d||"Error while searching"),i(null)}}))}}},"function"==typeof t?null==t?void 0:t(D,O):t,r&&n.createElement(c.A,{note:"Connecting to market",coverFullPage:!0}))}const h={0:"initial_feed",1:"live_feed",2:"market_info"},p={0:"ltpc",1:"full_d5",2:"option_greeks",3:"full_d30"},b={0:"PRE_OPEN_START",1:"PRE_OPEN_END",2:"NORMAL_OPEN",3:"NORMAL_CLOSE",4:"CLOSING_START",5:"CLOSING_END"};function y(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:t.ltp=B(e);break;case 2:t.ltt=z(e,!1);break;case 3:t.ltq=z(e,!1);break;case 4:t.cp=B(e);break;default:P(e,7&r)}}return t}function g(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:{let r=N(e);(t.bidAskQuote||(t.bidAskQuote=[])).push(k(e)),e.limit=r;break}default:P(e,7&r)}}return t}function w(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:{let r=N(e);(t.ohlc||(t.ohlc=[])).push(E(e)),e.limit=r;break}default:P(e,7&r)}}return t}function k(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:t.bidQ=z(e,!1);break;case 2:t.bidP=B(e);break;case 3:t.askQ=z(e,!1);break;case 4:t.askP=B(e);break;default:P(e,7&r)}}return t}function x(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:t.delta=B(e);break;case 2:t.theta=B(e);break;case 3:t.gamma=B(e);break;case 4:t.vega=B(e);break;case 5:t.rho=B(e);break;default:P(e,7&r)}}return t}function E(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:t.interval=L(e,q(e));break;case 2:t.open=B(e);break;case 3:t.high=B(e);break;case 4:t.low=B(e);break;case 5:t.close=B(e);break;case 6:t.vol=z(e,!1);break;case 7:t.ts=z(e,!1);break;default:P(e,7&r)}}return t}function S(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:{let r=N(e);t.ltpc=y(e),e.limit=r;break}case 2:{let r=N(e);t.marketLevel=g(e),e.limit=r;break}case 3:{let r=N(e);t.optionGreeks=x(e),e.limit=r;break}case 4:{let r=N(e);t.marketOHLC=w(e),e.limit=r;break}case 5:t.atp=B(e);break;case 6:t.vtt=z(e,!1);break;case 7:t.oi=B(e);break;case 8:t.iv=B(e);break;case 9:t.tbq=B(e);break;case 10:t.tsq=B(e);break;default:P(e,7&r)}}return t}function v(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:{let r=N(e);t.ltpc=y(e),e.limit=r;break}case 2:{let r=N(e);t.marketOHLC=w(e),e.limit=r;break}default:P(e,7&r)}}return t}function A(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:{let r=N(e);t.marketFF=S(e),e.limit=r;break}case 2:{let r=N(e);t.indexFF=v(e),e.limit=r;break}default:P(e,7&r)}}return t}function D(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:{let r=N(e);t.ltpc=y(e),e.limit=r;break}case 2:{let r=N(e);t.firstDepth=k(e),e.limit=r;break}case 3:{let r=N(e);t.optionGreeks=x(e),e.limit=r;break}case 4:t.vtt=z(e,!1);break;case 5:t.oi=B(e);break;case 6:t.iv=B(e);break;default:P(e,7&r)}}return t}function O(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:{let r=N(e);t.ltpc=y(e),e.limit=r;break}case 2:{let r=N(e);t.fullFeed=A(e),e.limit=r;break}case 3:{let r=N(e);t.firstLevelWithGreeks=D(e),e.limit=r;break}case 4:t.requestMode=p[q(e)];break;default:P(e,7&r)}}return t}function C(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:{let r,n,a=t.segmentStatus||(t.segmentStatus={}),o=N(e);t:for(;!M(e);){let t=q(e);switch(t>>>3){case 0:break t;case 1:r=L(e,q(e));break;case 2:n=b[q(e)];break;default:P(e,7&t)}}if(void 0===r||void 0===n)throw new Error("Invalid data for map: segmentStatus");a[r]=n,e.limit=o;break}default:P(e,7&r)}}return t}function T(e){return function(e){let t={};e:for(;!M(e);){let r=q(e);switch(r>>>3){case 0:break e;case 1:t.type=h[q(e)];break;case 2:{let r,n,a=t.feeds||(t.feeds={}),o=N(e);t:for(;!M(e);){let t=q(e);switch(t>>>3){case 0:break t;case 1:r=L(e,q(e));break;case 2:{let t=N(e);n=O(e),e.limit=t;break}default:P(e,7&t)}}if(void 0===r||void 0===n)throw new Error("Invalid data for map: feeds");a[r]=n,e.limit=o;break}case 3:t.currentTs=z(e,!1);break;case 4:{let r=N(e);t.marketInfo=C(e),e.limit=r;break}default:P(e,7&r)}}return t}(_(e))}function N(e){let t=q(e),r=e.limit;return e.limit=e.offset+t,r}function P(e,t){switch(t){case 0:for(;128&$(e););break;case 2:j(e,q(e));break;case 5:j(e,4);break;case 1:j(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let I=new Float32Array(1),F=(new Uint8Array(I.buffer),new Float64Array(1)),U=new Uint8Array(F.buffer);function _(e){return{bytes:e,offset:0,limit:e.length}}function j(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function M(e){return e.offset>=e.limit}function R(e,t){let r=e.offset;if(r+t>e.limit)throw new Error("Read past limit");return e.offset+=t,r}function L(e,t){let r=R(e,t),n=String.fromCharCode,a=e.bytes,o="�",s="";for(let c=0;c<t;c++){let e,l,i,u,d=a[c+r];128&d?192==(224&d)?c+1>=t?s+=o:(e=a[c+r+1],128!=(192&e)?s+=o:(u=(31&d)<<6|63&e,u<128?s+=o:(s+=n(u),c++))):224==(240&d)?c+2>=t?s+=o:(e=a[c+r+1],l=a[c+r+2],32896!=(49344&(e|l<<8))?s+=o:(u=(15&d)<<12|(63&e)<<6|63&l,u<2048||u>=55296&&u<=57343?s+=o:(s+=n(u),c+=2))):240==(248&d)?c+3>=t?s+=o:(e=a[c+r+1],l=a[c+r+2],i=a[c+r+3],8421504!=(12632256&(e|l<<8|i<<16))?s+=o:(u=(7&d)<<18|(63&e)<<12|(63&l)<<6|63&i,u<65536||u>1114111?s+=o:(u-=65536,s+=n(55296+(u>>10),56320+(1023&u)),c+=3))):s+=o:s+=n(d)}return s}function $(e){return e.bytes[R(e,1)]}function B(e){let t=R(e,8),r=e.bytes;return U[0]=r[t++],U[1]=r[t++],U[2]=r[t++],U[3]=r[t++],U[4]=r[t++],U[5]=r[t++],U[6]=r[t++],U[7]=r[t++],F[0]}function q(e){let t,r=0,n=0;do{t=$(e),r<32&&(n|=(127&t)<<r),r+=7}while(128&t);return n}function z(e,t){let r,n=0,a=0,o=0;return r=$(e),n=127&r,128&r&&(r=$(e),n|=(127&r)<<7,128&r&&(r=$(e),n|=(127&r)<<14,128&r&&(r=$(e),n|=(127&r)<<21,128&r&&(r=$(e),a=127&r,128&r&&(r=$(e),a|=(127&r)<<7,128&r&&(r=$(e),a|=(127&r)<<14,128&r&&(r=$(e),a|=(127&r)<<21,128&r&&(r=$(e),o=127&r,128&r&&(r=$(e),o|=(127&r)<<7))))))))),{low:n|a<<28,high:a>>>4|o<<24,unsigned:t}}var Q=r(6660);const W=(0,n.createContext)({quotes:{},socketStatus:0,tick:0,subscribeToQuotes:async e=>{},unsubscribeToQuotes:e=>{}});function X(e){let{children:t}=e;const{id:r,accessToken:a,checkIfAccessTokenIsAlive:o}=(0,n.useContext)(i),s=(0,n.useRef)({}),{socketStatus:c,tick:l,sendData:u}=(0,Q.A)((async()=>{try{const e=await fetch("https://api.upstox.com/v3/feed/market-data-feed/authorize",{method:"GET",headers:{Accept:"application/json",Authorization:"Bearer "+a}}),t=await e.json();return Object.hasOwn(t,"status")?"success"!==t.status?null:Object.hasOwn(t,"data")&&Object.hasOwn(t.data,"authorized_redirect_uri")?t.data.authorized_redirect_uri:null:null}catch(e){return null}}),(async e=>{try{const i=await e.arrayBuffer();if(!i)return!1;if(i.byteLength<=2)return!1;try{const e=T(new Uint8Array(i));console.log("feedResponse:",e);const l=[];for(const i in e.feeds){var t,r,n,a,o,c;if(null!==(t=e.feeds[i])&&void 0!==t&&null!==(r=t.ltpc)&&void 0!==r&&r.ltp)s.current[i]={ltp:null===(n=e.feeds[i])||void 0===n||null===(a=n.ltpc)||void 0===a?void 0:a.ltp,cp:(null===(o=e.feeds[i])||void 0===o||null===(c=o.ltpc)||void 0===c?void 0:c.cp)||0};else l.push(i)}}catch(l){console.error(l)}return!0}catch(l){return!1}}),null),d=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),f=e=>{for(var t=new ArrayBuffer(e.length),r=new Uint8Array(t),n=0,a=e.length;n<a;n++)r[n]=e.charCodeAt(n);return t};return n.createElement(W.Provider,{value:{quotes:s.current,socketStatus:c,tick:l,subscribeToQuotes:async e=>{try{if(!e)return!1;if("Array"!==e.constructor.name)return!1;if(e.length<1)return!1;if(!await o())return!1;if((e=e.filter((e=>e))).length<1)return!1;const t={guid:d(),method:"sub",data:{mode:"ltpc",instrumentKeys:e}};return await u(f(JSON.stringify(t)),!0,!0)}catch(t){return console.error(t),!1}},unsubscribeToQuotes:e=>{if(!e)return!1;if("Array"!==e.constructor.name)return!1;if(e.length<1)return!1;if((e=e.filter((e=>e))).length<1)return!1;try{const t={guid:d(),method:"unsub",data:{mode:"ltpc",instrumentKeys:e}};u(f(JSON.stringify(t)));for(const r of e)Object.hasOwn(s.current,r)&&delete s.current[r];return!0}catch(t){return console.error(t),!1}}}},t)}var V=r(5946),G=r(8583),K=r(4506),H=r(7765),J=r(1291),Z=r(4398),Y=r(9322),ee=r(8208),te=r(998),re=r(6278),ne=r(6422),ae=r(7486);function oe(){const{notify:e}=(0,n.useContext)(a._),t=(0,n.useContext)(o.M),{id:r,checkIfPlanActive:s,checkIfLoginSessionIsValid:c}=(0,n.useContext)(d.R),{name:l,logOut:u}=(0,n.useContext)(i),{isMasterDataReady:m,searchInstruments:h}=(0,n.useContext)(f),{socketStatus:p,quotes:b,tick:y,subscribeToQuotes:g,unsubscribeToQuotes:w}=(0,n.useContext)(W),{0:k,1:x}=(0,n.useState)([]),{0:E,1:S}=(0,n.useState)([]),{0:v,1:A}=(0,n.useState)(0),{0:D,1:O}=(0,n.useState)(null),{0:C,1:T}=(0,n.useState)(null),{0:N,1:P}=(0,n.useState)(!1),I=(0,n.useCallback)((async e=>{try{if(!Array.isArray(e))throw new Error("Array of instruments expected");return!(e.length<1)&&await g(e.map((e=>{let{token:t}=e;return t})))}catch(t){return console.error("SCAFFOLD: subscribeToQuotes_mod():",t.message||t),!1}}),[]),F=(0,n.useCallback)((e=>{try{if(!Array.isArray(e))throw new Error("Array of watchlist instruments expected");return!(e.length<1)&&w(e.map((e=>{let{token:t}=e;return t})))}catch(t){return console.error("SCAFFOLD: unsubscribeToQuotes_mod():",t.message||t),!1}}),[]),U=(0,ae.A)(k,E,D,I,F,p,m),_=async(r,n)=>{if(!t)return e("Network Unavailable","alert"),!1;try{return r.isNotTradeable?(e(r.symbol+" is not tradeable","alert"),!1):(O(r),!0)}catch(a){return!1}},j=async(e,t,n)=>{try{if(!await c())return!1;await s();const a=await browser.runtime.sendMessage({action:"position_exit",userId:r,tradingsymbol:e.symbol,exchange:e.exchange,exitPrice:t,exitQty:e.qty,isSellTrade:n||!1,brokerCode:"us"});if(!a||!Object.hasOwn(a,"status"))return!1;if("error"===a.status)throw new Error(a.error);return"success"===a.status&&(!!Object.hasOwn(a,"exitedPosition")&&(M(a.exitedPosition),!0))}catch(a){console.error(a)}},M=e=>{const t=k.find((t=>t.symbol===e.sbl&&t.exchange===e.xh&&t.dir===e.dir));t&&(t.qty===e.qty?x(k.filter((t=>!(t.symbol===e.sbl&&t.exchange===e.xh&&t.dir===e.dir)))):e.qty<t.qty&&x(k.map((t=>(t.symbol===e.sbl&&t.exchange===e.xh&&t.dir===e.dir&&(t.qty=t.qty-e.qty,t.h=Object.hasOwn(t,"h")&&t.h&&Array.isArray(t.h)?[[Date.now(),-1*e.qty,e.cp]].concat((0,K.A)(t.h)):[[Date.now(),-1*e.qty,e.cp]]),t)))))};return(0,n.useEffect)((()=>{if(Object.keys(b).length<1)return;let t=0;k.forEach((r=>{if(!Object.hasOwn(b,r.token))return;const n=b[r.token].ltp;"B"===r.dir?(t+=(n-r.avg)*r.qty,null!==r.sl&&void 0!==r.sl&&n<=r.sl&&(j(r,r.sl,!1),e(`SL hit for ${r.exchange}:${r.symbol} buy trade`,"alert")),null!==r.tp&&void 0!==r.tp&&n>=r.tp&&(j(r,r.tp,!1),e(`TP hit for ${r.exchange}:${r.symbol} buy trade`,"success"))):(t+=(r.avg-n)*r.qty,null!==r.sl&&void 0!==r.sl&&n>=r.sl&&(j(r,r.sl,!0),e(`SL hit for ${r.exchange}:${r.symbol} sell trade`,"alert")),null!==r.tp&&void 0!==r.tp&&n<=r.tp&&(j(r,r.tp,!0),e(`TP hit for ${r.exchange}:${r.symbol} sell trade`,"success")))})),A(t)}),[y,k]),n.createElement(n.Fragment,null,n.createElement(Z.j,{broker:"Upstox",brokerLoggedInUserName:l,brokerLogOut:u,doOnWatchListBtnClick:P.bind(this,!0)}),n.createElement(H.A,{currentBroker:"Upstox",currentBrokerCode:"us",isMasterDataReady:m,socketStatus:p,isSocketRetryWip:U,positionsAry:k,setPositionsAry:x,invokeInstrumentForTransaction:_,instrumentInvokedForTransaction:D,renderNewPosDialog:(e,t)=>D&&n.createElement(te.A,{doNotCloseIfClickedOnBackdrop:!0,doOnClose:O.bind(this,null)},(r=>{var a,o;const{token:s,symbol:c,exchange:l,lotSize:i}=D;return n.createElement(re.A,{instrument:D,ltp:null==b||null===(a=b[s])||void 0===a?void 0:a.ltp,closePrice:null==b||null===(o=b[s])||void 0===o?void 0:o.cp,enterPosition:e,doOnOpeningOrUpdatingPos:()=>{t(),P(!1)},closeDialog:r})})),posInvokedForViewingDetailsOrExiting:C,renderPosMgmtDialog:(e,t)=>n.createElement(te.A,{doOnClose:T.bind(this,null)},(r=>{var a;return n.createElement(ne.A,{positionToExit:C,ltp:null==b||null===(a=b[C.token])||void 0===a?void 0:a.ltp,exitPosition:e,addLotsToPosition:t,closeDialog:r})})),totalPnL:v,calcPnlPerExchangeType:()=>{if(Object.keys(b).length<1)return null;let e=0,t=0,r=0,n=0;return k.forEach((a=>{if(!Object.hasOwn(b,a.token))return;const o="B"===a.dir?(b[a.token].ltp-a.avg)*a.qty:(a.avg-b[a.token].ltp)*a.qty;"NSE"===a.exchange||"BSE"===a.exchange?e+=o:"NFO"===a.exchange?t+=o:"MCX"===a.exchange?r+=o:"CDS"===a.exchange&&(n+=o)})),{eq:e,fno:t,com:r,cds:n,total:e+t+r+n}},searchFilterExchangesAry:["NSE","BSE","NFO","CDS","MCX"],searchInstruments:h},k.map(((e,t)=>{var r;const{symbol:a,exchange:o,avg:l,qty:i,dir:u,expiry:d,token:f}=e;return n.createElement(Y.A,{wrapperElement:"div",key:`${t}:${f}`,tradingsymbol:a,exchange:o,qty:i,avg:l,ltp:null==b||null===(r=b[f])||void 0===r?void 0:r.ltp,direction:u,onClick:async t=>{await c()&&(await s(),T(e),t.stopPropagation())}})}))),N&&n.createElement(te.A,{doOnClose:()=>{S([]),P(!1)}},n.createElement(J.A,{currentBroker:"Upstox",currentBrokerCode:"us",isMasterDataReady:m,socketStatus:p,isSocketRetryWip:U,watchlistInstrumentsAry:E,setWatchlistInstrumentsAry:S,searchFilterExchangesAry:["NSE","BSE","NFO","CDS","MCX"],searchInstruments:h},((r,a,o)=>E.map(((s,c)=>{var l,i;const{symbol:u,name:d,token:f,exchange:m,expiry:h,isNotTradeable:p}=s,y=a&&a.token===f;return n.createElement(ee.A,{wrapperElement:"div",key:f,onClick:o.bind(this,y?{}:s),isExpandedView:y,tradingsymbol:u,entityName:d,exchange:m,ltp:null==b||null===(l=b[f])||void 0===l?void 0:l.ltp,closePrice:null==b||null===(i=b[f])||void 0===i?void 0:i.cp,expiry:h,closeExpandedView:o.bind(this,{}),isNotTradeable:p,onBuyClick:()=>{var r;t?null!=b&&null!==(r=b[f])&&void 0!==r&&r.ltp?(async()=>{await _(s)})():e("Error inferring price for "+u,"err"):e("Network unavailable","err")},onRemoveClick:()=>{r(u,m,f).then((()=>{o({})}))}})}))))))}function se(){return n.createElement(u,null,n.createElement(m,null,((e,t)=>n.createElement(V.A,null,n.createElement(G.A,{currentBrokerCode:"us",masterData_getInstrument:e,masterData_getInstruments:t},n.createElement(X,null,n.createElement(oe,null)))))))}},5474:function(e,t,r){r.r(t),r.d(t,{Head:function(){return l},default:function(){return c}});var n=r(6540),a=r(4140),o=r(268),s=r(8719);function c(){return n.createElement(a.A,null,n.createElement(o.A,null,(()=>{const e=r(5319).A;return n.createElement(e,null)})))}function l(){return n.createElement(s.y,{title:"Upstox"})}}}]);